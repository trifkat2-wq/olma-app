<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <title>Olma Market ‚Äî –ü–æ–∏—Å–∫ –º–µ–Ω–µ–¥–∂–µ—Ä–∞</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <style>
        :root{
            --olma-red: rgb(239,62,45);
            --olma-green: rgb(77,185,109);
            --olma-yellow: rgb(255,198,62);
            --olma-black: #202020;
            --card-w: 520px;
        }
        *{box-sizing:border-box}
        body{
            margin:0;
            font-family: Arial, Helvetica, sans-serif;
            background:#f3f4f6;
            display:flex;
            flex-direction: column;
            align-items:center;
            min-height:100vh;
        }

        .top-nav {
            width: 100%;
            background-color: #ffffff;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            padding: 12px 16px;
            display: flex;
            justify-content: center;
            gap: 12px;
            order: -1; 
        }
        .top-nav .btn-journal {
             box-shadow: none;
             border: 1.5px solid #e5e7eb;
        }
        .top-nav .btn-journal:hover {
            background-color: #f9fafb;
            border-color: #d1d5db;
        }
        #mainApp {
            width: 100%;
            display: flex;
            justify-content: center;
            padding: 24px 0;
        }
        
        .card{
            width: min(var(--card-w), 96vw);
            background:#fff;
            border-radius:16px;
            box-shadow:0 8px 24px rgba(0,0,0,.12);
            padding:22px 24px 18px;
            text-align:center;
        }
        .logo{ width:180px; margin:2px auto 10px; display:block; object-fit:contain; }
        h1, h2{ margin:4px 0 14px; color:var(--olma-black); }
        h1 { font-size:28px; }
        h2 { font-size:22px; }
        textarea, select, input[type="password"] {
            display:block; width:100%;
            padding:10px 12px; border:1.5px solid #d1d5db; border-radius:10px;
            font-family: ui-monospace, monospace; font-size:14px; line-height:1.4;
            resize:vertical; margin:0 auto 14px;
        }
        textarea{ height:120px; }
        .btn{
            display:block; width:100%; border:none; border-radius:12px;
            padding:12px 16px; font-size:16px; font-weight:700;
            cursor:pointer; transition:transform .02s ease, opacity .2s ease;
            color:#fff; margin:10px auto 0;
        }
        .btn:active{ transform:scale(.995); }
        .btn[disabled] { background-color: #9ca3af; cursor: not-allowed; }
        .btn-red{ background:var(--olma-red); }
        .btn-green{ background:var(--olma-green); }
        .btn-yellow{ background:var(--olma-yellow); color:#212121; }
        .results{ text-align:left; margin-top:14px; }
        .mgr{ font-weight:700; color:var(--olma-black); margin:14px 0 6px }
        ol{ margin:6px 0 0 18px; padding-left: 18px; }
        .muted{ color:#6b7280; font-style:italic; margin-top:8px }
        .copy-wrap{ display:none; margin-top:12px; text-align:center; }
        .copy-btn{ width:28px; height:28px; border:none; background:transparent; cursor:pointer; opacity:.75; padding:0; margin:0 auto; }
        .copy-btn:hover{ opacity:1 } .copy-btn:active{ transform:scale(.98) }
        .copy-btn svg{ width:100%; height:100%; display:block; }
        
        .btn-journal{
            background:#fff; border:none; border-radius:8px; padding:6px 12px;
            font-weight:600; font-size:14px; cursor:pointer;
            box-shadow:0 2px 6px rgba(0,0,0,.15);
            line-height: 1.2;
        }
        .btn-journal:hover{ background:#f9f9f9; }
        
        .overlay{
            position:fixed; top:0; left:0; right:0; bottom:0;
            background:rgba(0,0,0,0.4);
            display:flex; align-items:center; justify-content:center;
            z-index:1000;
        }
        .password-overlay, .confirm-overlay { z-index: 1100; }
        
        .journal-window{
            width:90vw; height:80vh;
            background:#fff; border-radius:14px;
            box-shadow:0 8px 24px rgba(0,0,0,.25);
            display:flex; flex-direction:column; overflow:hidden;
        }
        .journal-header{
            flex:0 0 auto; padding:12px 16px; background:#f3f4f6;
            border-bottom:1px solid #ddd; display:flex; justify-content:space-between; align-items:center;
        }
        .journal-header h2{ margin:0; font-size:18px; font-weight:700; }
        .journal-close{ border:none; background:transparent; font-size:20px; cursor:pointer; }
        .journal-body{ flex:1 1 auto; overflow:auto; padding:12px; text-align:left; }
        table.journal-table{ border-collapse:collapse; width:100%; font-size:14px; }
        .journal-table th,.journal-table td{ border:1px solid #ddd; padding:6px 8px; text-align:left; vertical-align: top; }
        .journal-table th{ background:#f9fafb; }
        .journal-table select { border: 1px solid #ddd; border-radius: 4px; padding: 2px; }
        .journal-footer{ padding:10px; border-top:1px solid #ddd; text-align:right; display:flex; justify-content:space-between; }
        .btn-export-journal, .btn-clear-journal{
            background:var(--olma-green); color:#fff; border:none;
            padding:8px 14px; border-radius:8px; font-weight:600; cursor:pointer;
        }
        .btn-clear-journal{ background:var(--olma-red); }
        
        details.date-group { border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 12px; }
        details.date-group summary {
            font-weight: 700; font-size: 16px; padding: 10px 14px; cursor: pointer;
            background-color: #f9fafb;
        }
        details[open].date-group summary { border-bottom: 1px solid #e5e7eb; }
        .date-content { padding: 8px; }

        .modal-window .form-group{ text-align: left; margin-bottom: 12px; }
        .modal-window .form-group label{ font-weight: 600; font-size: 14px; margin-bottom: 4px; display: block; }
        .modal-window p { margin: 10px 0 20px; }
        .modal-buttons { display: flex; gap: 10px; justify-content: flex-end; }

        .toast {
            position: fixed; top: 20px; left: 50%;
            transform: translateX(-50%);
            background-color: var(--olma-green); color: white;
            padding: 12px 20px; border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 2000; opacity: 0; visibility: hidden;
            transition: opacity 0.3s ease, top 0.3s ease, visibility 0.3s ease;
        }
        .toast.show { opacity: 1; visibility: visible; top: 40px; }
        .toast.error { background-color: var(--olma-red); }

        @media (max-width: 520px) {
            .card { padding: 20px 16px 16px; }
            h1 { font-size: 24px; margin-bottom: 12px; }
            .btn { padding: 11px 14px; font-size: 15px; margin-top: 8px; }
            textarea { height: 100px; font-size: 13px; }
            .logo { width: 150px; }
            .journal-window { width: 95vw; height: 85vh; }
        }
    </style>
</head>
<body>
    <div id="welcomeOverlay" class="overlay">
        <div class="card welcome-card">
            <img class="logo" src="logo_olma_hd_transparent.png" alt="Olma Market" onerror="this.style.display='none'">
            <h1>–ü—Ä–∏–≤–µ—Ç!</h1>
            <p>–í—ã–±–µ—Ä–∏—Ç–µ —Å–≤–æ–µ –§–ò–û, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É.</p>
            <select id="userSelect">
                <option value="" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</option>
                <option value="–¢–∏–º–∞–µ–≤ –†–∏—Ñ–∫–∞—Ç">–¢–∏–º–∞–µ–≤ –†–∏—Ñ–∫–∞—Ç</option>
                <option value="–ì—É–ª–∞–º–æ–≤–∞ –°–∞–±–∏–Ω–∞">–ì—É–ª–∞–º–æ–≤–∞ –°–∞–±–∏–Ω–∞</option>
                <option value="–¢—É—Ä—Å—É–Ω–æ–≤–∞ –£–º–∏–¥–∞">–¢—É—Ä—Å—É–Ω–æ–≤–∞ –£–º–∏–¥–∞</option>
                <option value="–î–æ–Ω–∏–µ—Ä –ê–ª–∏–±–∞–µ–≤">–î–æ–Ω–∏–µ—Ä –ê–ª–∏–±–∞–µ–≤</option>
                <option value="–ù–∞—Ç–∞–ª–∏—è –Æ—Å—É–ø–æ–≤–∞">–ù–∞—Ç–∞–ª–∏—è –Æ—Å—É–ø–æ–≤–∞</option>
                <option value="–®–∞—Ö–Ω–æ–∑–∞ –†–∞—Ö–º–∞–Ω–∫—É–ª–æ–≤–∞">–®–∞—Ö–Ω–æ–∑–∞ –†–∞—Ö–º–∞–Ω–∫—É–ª–æ–≤–∞</option>
            </select>
            <button class="btn btn-red" id="btnStart">–ù–∞—á–∞—Ç—å</button>
        </div>
    </div>

    <div class="top-nav" id="topNav" style="display: none;">
        <button class="btn-journal" id="btnGuests">–ì–æ—Å—Ç–∏</button>
        <button class="btn-journal" id="btnTraining">–¢—Ä–µ–Ω–∏–Ω–≥</button>
        <button class="btn-journal" id="btnJournal">–ñ—É—Ä–Ω–∞–ª</button>
    </div>

    <div id="mainApp" style="display: none;">
        <div class="card">
            <img class="logo" src="logo_olma_hd_transparent.png" alt="Olma Market" onerror="this.style.display='none'">
            <h1>–ü–æ–∏—Å–∫ –º–µ–Ω–µ–¥–∂–µ—Ä–∞</h1>
            <textarea id="input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç"></textarea>
            <button class="btn btn-red" id="btnSearch">–ü–æ–∫–∞–∑–∞—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞</button>
            <button class="btn btn-green" id="btnExport">–≠–∫—Å–ø–æ—Ä—Ç –ø–æ–∏—Å–∫–∞ –≤ Excel</button>
            <input type="file" id="fileInput" accept=".xlsx,.xls" hidden>
            <button class="btn btn-yellow" id="btnImport">–ò–º–ø–æ—Ä—Ç –±–∞–∑—ã –∏–∑ Excel</button>
            <div id="results" class="results"></div>
            <div id="copyWrap" class="copy-wrap" style="display: none;">
                <button id="btnCopy" class="copy-btn"><svg viewBox="0 0 24 24"><path d="M16 2h-1.18A3 3 0 0 0 12 0a3 3 0 0 0-2.82 2H8a2 2 0 0 0-2 2v2h12V4a2 2 0 0 0-2-2zM6 8v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V8H6z"/></svg></button>
            </div>
            <div id="emptyMsg" class="muted"></div>
            <div id="dbStatus" class="muted" style="font-size: 12px; margin-top: 5px; font-weight: bold;"></div>
        </div>
    </div>
    
    <div id="journalOverlay" class="overlay" style="display: none;">
        <div class="journal-window">
            <div class="journal-header">
                <h2 id="journalTitle">–ñ—É—Ä–Ω–∞–ª –ø–æ–∏—Å–∫–∞</h2>
                <button class="journal-close" id="closeJournal">√ó</button>
            </div>
            <div class="journal-body" id="journalBody"></div>
            <div class="journal-footer">
                <button class="btn-clear-journal" id="btnClearJournal">–û—á–∏—Å—Ç–∏—Ç—å –∂—É—Ä–Ω–∞–ª</button>
                <button class="btn-export-journal" id="btnExportJournal">–≠–∫—Å–ø–æ—Ä—Ç –∂—É—Ä–Ω–∞–ª–∞</button>
            </div>
        </div>
    </div>
    
    <div id="filterOverlay" class="overlay" style="display: none;">
        <div class="card modal-window" style="width: min(400px, 90vw);">
            <h2>–§–∏–ª—å—Ç—Ä –∂—É—Ä–Ω–∞–ª–∞</h2>
            <div class="form-group">
                <label for="filterUser">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</label>
                <select id="filterUser"></select>
            </div>
            <div class="modal-buttons">
                <button class="btn" id="btnCancelFilter" style="background-color: #6b7280;">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn btn-green" id="btnApplyFilter">–ü–æ–∫–∞–∑–∞—Ç—å</button>
            </div>
        </div>
    </div>

    <div id="passwordOverlay" class="password-overlay overlay" style="display: none;">
        <div class="card modal-window" style="width: min(400px, 90vw);">
            <h2>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</h2>
            <p>–î–ª—è —ç—Ç–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è –≤–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.</p>
            <div class="form-group">
                <label for="passwordInput">–ü–∞—Ä–æ–ª—å</label>
                <input type="password" id="passwordInput">
            </div>
            <div class="modal-buttons">
                <button class="btn" id="btnCancelClear" style="background-color: #6b7280;">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn btn-red" id="btnConfirmClear">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <div id="confirmOverlay" class="confirm-overlay overlay" style="display: none;">
         <div class="card modal-window" style="width: min(400px, 90vw);">
            <h2 id="confirmTitle">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ</h2>
            <p id="confirmMessage">–í—ã —É–≤–µ—Ä–µ–Ω—ã?</p>
            <div class="modal-buttons">
                <button class="btn" id="btnCancelAction" style="background-color: #6b7280;">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn btn-red" id="btnConfirmAction">–î–∞, —É–≤–µ—Ä–µ–Ω</button>
            </div>
        </div>
    </div>

    <div id="trainingOverlay" class="training-overlay overlay" style="display: none;">
        <div class="journal-window" style="width: min(600px, 90vw); height: 70vh;">
            <div class="journal-header">
                <h2>–°–ø–∏—Å–æ–∫ –Ω–∞ —Ç—Ä–µ–Ω–∏–Ω–≥</h2>
                <button class="journal-close" id="closeTraining">√ó</button>
            </div>
            <div class="journal-body">
                <h3 id="trainingStatus" style="text-align: center; margin-bottom: 15px;">–ó–∞–≥—Ä—É–∑–∫–∞...</h3>
                <ol id="trainingListContainer"></ol>
            </div>
            <div class="journal-footer">
                <button class="btn-export-journal" id="btnEditTrainingList">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–ø–∏—Å–æ–∫</button>
            </div>
        </div>
    </div>

    <div id="guestOverlay" class="guest-overlay overlay" style="display: none;">
        <div class="journal-window" style="width: min(700px, 90vw); height: 70vh;">
            <div class="journal-header">
                <h2>–ñ—É—Ä–Ω–∞–ª –ì–æ—Å—Ç–µ–π</h2>
                <button class="journal-close" id="closeGuests">√ó</button>
            </div>
            <div class="journal-body" id="guestListContainer"></div>
            <div class="journal-footer">
                <button class="btn-clear-journal" id="btnClearGuests">–û—á–∏—Å—Ç–∏—Ç—å –∂—É—Ä–Ω–∞–ª –≥–æ—Å—Ç–µ–π</button>
                <button class="btn-export-journal" id="btnExportGuests">–≠–∫—Å–ø–æ—Ä—Ç –≤ Excel</button>
            </div>
        </div>
    </div>

    <div id="uploadTrainingOverlay" class="upload-training-overlay overlay" style="display: none;">
        <div class="card modal-window" style="width: min(500px, 90vw);">
            <h2>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø–∏—Å–∫–∞</h2>
            <p>–î–æ–±–∞–≤—å—Ç–µ, —É–¥–∞–ª–∏—Ç–µ –∏–ª–∏ –∏—Å–ø—Ä–∞–≤—å—Ç–µ –§–ò–û. –ö–∞–∂–¥—ã–π —Å–æ—Ç—Ä—É–¥–Ω–∏–∫ —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏.</p>
            <textarea id="trainingListInput" style="height: 200px; font-size: 13px;"></textarea>
            <div class="modal-buttons">
                <button class="btn" id="btnCancelUpload" style="background-color: #6b7280;">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn btn-green" id="btnSaveTrainingList">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
            </div>
        </div>
    </div>

    <div id="toast" class="toast">
        <span id="toastMessage"></span>
    </div>

<script>
    const firebaseConfig = {
      apiKey: "AIzaSyDHrpashKVWzfqRWwp2fmrhfkvVNYEcMFI",
      authDomain: "olma-market-db.firebaseapp.com",
      projectId: "olma-market-db",
      storageBucket: "olma-market-db.appspot.com",
      messagingSenderId: "177102940053",
      appId: "1:77102940053:web:d799ea7b8c9e71b704789c"
    };

    firebase.initializeApp(firebaseConfig);
    const firestore = firebase.firestore();

    let DB = {}, currentUser = "", journal = [], displayedJournal = [], trainingList = [], guestList = [], initialTrainingListSize = 0;
    const dbStatusEl = document.getElementById('dbStatus'), importBtn = document.getElementById('btnImport');
    
    let toastTimeout;
    function showToast(message, isError = false) {
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toastMessage');
        clearTimeout(toastTimeout);
        toastMessage.textContent = message;
        toast.className = 'toast';
        if (isError) toast.classList.add('error');
        toast.classList.add('show');
        toastTimeout = setTimeout(() => { toast.classList.remove('show'); }, 3000);
    }

    function showConfirm(message, onConfirm) {
        const confirmOverlay = document.getElementById('confirmOverlay');
        document.getElementById('confirmMessage').textContent = message;
        confirmOverlay.style.display = 'flex';
        const btnConfirm = document.getElementById('btnConfirmAction');
        const btnCancel = document.getElementById('btnCancelAction');
        const confirmHandler = () => { onConfirm(); cleanup(); };
        const cancelHandler = () => { cleanup(); };
        const cleanup = () => {
            confirmOverlay.style.display = 'none';
            btnConfirm.removeEventListener('click', confirmHandler);
            btnCancel.removeEventListener('click', cancelHandler);
        };
        btnConfirm.addEventListener('click', confirmHandler, { once: true });
        btnCancel.addEventListener('click', cancelHandler, { once: true });
    }

    let passwordSuccessCallback = null;
    function requestPassword(onSuccess) {
        passwordSuccessCallback = onSuccess;
        document.getElementById('passwordInput').value = '';
        document.getElementById('passwordOverlay').style.display = 'flex';
    }
    
    document.getElementById('btnConfirmClear').addEventListener('click', () => {
        const passwordInput = document.getElementById('passwordInput');
        if (passwordInput.value === 'Trener') {
            if (passwordSuccessCallback) passwordSuccessCallback();
        } else {
            showToast("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!", true);
        }
        passwordInput.value = '';
        document.getElementById('passwordOverlay').style.display = 'none';
        passwordSuccessCallback = null;
    });
     document.getElementById('btnCancelClear').addEventListener('click', () => {
        document.getElementById('passwordInput').value = '';
        document.getElementById('passwordOverlay').style.display = 'none';
        passwordSuccessCallback = null;
    });

    async function loadDB() {
        dbStatusEl.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö...';
        importBtn.disabled = true;
        try {
            const doc = await firestore.collection("bases").doc("main").get();
            if (doc.exists && Object.keys(doc.data()).length > 0) {
                DB = doc.data();
                dbStatusEl.textContent = `–ë–∞–∑–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞: ${Object.keys(DB).length} –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤`;
            } else {
                DB = {};
                dbStatusEl.textContent = '–ë–∞–∑–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ò–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ —Ñ–∞–π–ª Excel.';
            }
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∞–∑—ã: ", error);
            dbStatusEl.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∞–∑—ã.';
        } finally {
            importBtn.disabled = false;
        }
    }

    async function saveDB(newDB) {
        dbStatusEl.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –±–∞–∑—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ...';
        importBtn.disabled = true;
        try {
            await firestore.collection("bases").doc("main").set(newDB);
            showToast("–ë–∞–∑–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!");
            setTimeout(() => window.location.reload(), 1500);
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –±–∞–∑—ã: ", error);
            showToast("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö.", true);
            dbStatusEl.textContent = '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.';
            importBtn.disabled = false;
        }
    }

    async function loadJournal(user) {
        if (!user) return [];
        try {
            const doc = await firestore.collection("journals").doc(user).get();
            return doc.exists ? (doc.data().entries || []) : [];
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∂—É—Ä–Ω–∞–ª–∞:", error);
            return [];
        }
    }

    async function saveJournal(user, journalData) {
        if (!user) return;
        try {
            await firestore.collection("journals").doc(user).set({ entries: journalData });
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∂—É—Ä–Ω–∞–ª–∞:", error);
        }
    }

    async function loadTrainingList() {
        try {
            const doc = await firestore.collection("app_data").doc("training").get();
            if (doc.exists) {
                trainingList = doc.data().fio_list || [];
                initialTrainingListSize = doc.data().initial_size || trainingList.length;
            } else {
                trainingList = [];
                initialTrainingListSize = 0;
            }
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –Ω–∞ —Ç—Ä–µ–Ω–∏–Ω–≥:", error);
            trainingList = [];
            initialTrainingListSize = 0;
        }
    }

    async function saveTrainingList(newList, isNewUpload = false) {
        try {
            const dataToSave = { fio_list: newList };
            if (isNewUpload) {
                dataToSave.initial_size = newList.length;
            } else {
                dataToSave.initial_size = initialTrainingListSize;
            }
            await firestore.collection("app_data").doc("training").set(dataToSave, { merge: true });
            showToast("–°–ø–∏—Å–æ–∫ –Ω–∞ —Ç—Ä–µ–Ω–∏–Ω–≥ –æ–±–Ω–æ–≤–ª–µ–Ω!");
            await loadTrainingList();
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –Ω–∞ —Ç—Ä–µ–Ω–∏–Ω–≥:", error);
            showToast("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞.", true);
        }
    }

    async function loadGuestList() {
        try {
            const doc = await firestore.collection("app_data").doc("guests").get();
            guestList = doc.exists ? (doc.data().entries || []) : [];
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∂—É—Ä–Ω–∞–ª–∞ –≥–æ—Å—Ç–µ–π:", error);
            guestList = [];
        }
    }

    async function saveGuestList(updatedGuestList) {
        try {
            await firestore.collection("app_data").doc("guests").set({ entries: updatedGuestList });
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∂—É—Ä–Ω–∞–ª–∞ –≥–æ—Å—Ç–µ–π:", error);
        }
    }
    
    function transliterate(text) {
        text = text.toLowerCase();
        const a = {"—ë":"yo","–π":"i","—Ü":"ts","—É":"u","–∫":"k","–µ":"e","–Ω":"n","–≥":"g","—à":"sh","—â":"sch","–∑":"z","—Ö":"h","—ä":"'","—Ñ":"f","—ã":"i","–≤":"v","–∞":"a","–ø":"p","—Ä":"r","–æ":"o","–ª":"l","–¥":"d","–∂":"zh","—ç":"e","—è":"ya","—á":"ch","—Å":"s","–º":"m","–∏":"i","—Ç":"t","—å":"'","–±":"b","—é":"yu","–Å":"YO","–ô":"I","–¶":"TS","–£":"U","–ö":"K","–ï":"E","–ù":"N","–ì":"G","–®":"SH","–©":"SCH","–ó":"Z","–•":"H","–™":"'","–§":"F","–´":"I","–í":"V","–ê":"a","–ü":"P","–†":"R","–û":"O","–õ":"L","–î":"D","–ñ":"ZH","–≠":"E","–Ø":"Ya","–ß":"CH","–°":"S","–ú":"M","–ò":"I","–¢":"T","–¨":"'","–ë":"B","–Æ":"YU"};
        return text.split('').map(char => a[char] || char).join("");
    }

    function similarity(s1, s2) {
        let longer = s1, shorter = s2;
        if (s1.length < s2.length) { longer = s2; shorter = s1; }
        const longerLength = longer.length;
        if (longerLength === 0) return 1.0;
        return (longerLength - editDistance(longer, shorter)) / parseFloat(longerLength);
    }

    function editDistance(s1, s2) {
        const costs = [];
        for (let i = 0; i <= s1.length; i++) {
            let lastValue = i;
            for (let j = 0; j <= s2.length; j++) {
                if (i === 0) costs[j] = j;
                else if (j > 0) {
                    let newValue = costs[j - 1];
                    if (s1.charAt(i - 1) !== s2.charAt(j - 1)) newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
                    costs[j - 1] = lastValue;
                    lastValue = newValue;
                }
            }
            if (i > 0) costs[s2.length] = lastValue;
        }
        return costs[s2.length];
    }
    
    const CODE_RE = /([A-Z–ê-–Ø])\s*-?\s*0*(\d+)/ig;
    function normalizeCode(letter, numberStr) {
        const letterMap = { '–ú': 'M', '–ê': 'A', '–ö': 'K', '–°': 'C', '–†': 'R' };
        return `${letterMap[letter.toUpperCase()] || letter.toUpperCase()}-${parseInt(numberStr, 10)}`;
    }

    function buildCodeMap(db){
        const map = {};
        for (const [manager, codes] of Object.entries(db)) {
            if (Array.isArray(codes)) {
                for (const code of codes) {
                    CODE_RE.lastIndex = 0;
                    const match = CODE_RE.exec(String(code));
                    if (match) map[normalizeCode(match[1], match[2])] = manager;
                }
            }
        }
        return map;
    }

    let lastExport={};

    async function doSearch() {
        const ta = document.getElementById('input');
        const raw = ta.value.trim();
        const out = document.getElementById('results');
        const empty = document.getElementById('emptyMsg');
        const copyWrap = document.getElementById('copyWrap');
        out.innerHTML = ''; empty.textContent = ''; copyWrap.style.display = 'none';

        if (!raw) { empty.textContent = '–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ'; return; }
        if (Object.keys(DB).length === 0) { empty.textContent = '–ë–∞–∑–∞ –ø—É—Å—Ç–∞.'; return; }

        const lines = raw.split(/\n/).map(s => s.trim()).filter(Boolean);
        const codeMap = buildCodeMap(DB);
        const grouped = {};
        let guests = [];
        const guestRegex = /\b(–¢–ú|–ê–ú|–ó–ú|–†–ú)\b/i;
        
        const preparedTrainingList = trainingList.map(fio => transliterate(fio));

        for (const line of lines) {
            let hasManager = false;
            let isGuestByCode = guestRegex.test(line);
            
            CODE_RE.lastIndex = 0;
            let match;
            while ((match = CODE_RE.exec(line)) !== null) {
                const manager = codeMap[normalizeCode(match[1], match[2])];
                if (manager) {
                    if (!grouped[manager]) grouped[manager] = [];
                    if (!grouped[manager].includes(line)) grouped[manager].push(line);
                    hasManager = true;
                }
            }

            let isInTraining = false;
            if (hasManager) {
                const preparedLine = transliterate(line);
                for (const trainingFio of preparedTrainingList) {
                    if (similarity(preparedLine, trainingFio) > 0.65) {
                        isInTraining = true;
                        break;
                    }
                }
            }
            
            if (isGuestByCode || !hasManager || (hasManager && !isInTraining)) {
                guests.push(line);
                if (hasManager) {
                    for (const manager in grouped) {
                        grouped[manager] = grouped[manager].filter(item => item !== line);
                        if (grouped[manager].length === 0) delete grouped[manager];
                    }
                }
            }
        }
        
        const now = new Date().toLocaleString('ru-RU', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });

        if (guests.length > 0) {
            const newGuestEntries = guests.map(g => ({ id: Date.now() + Math.random(), user: currentUser, text: g, date: now }));
            const currentGuestTexts = new Set(guestList.map(g => g.text));
            const trulyNewEntries = newGuestEntries.filter(g => !currentGuestTexts.has(g.text));

            if (trulyNewEntries.length > 0) {
                await saveGuestList([...guestList, ...trulyNewEntries]);
                await loadGuestList();
                showToast(`${trulyNewEntries.length} —á–µ–ª. –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∂—É—Ä–Ω–∞–ª –≥–æ—Å—Ç–µ–π.`);
            }
        }

        if (Object.keys(grouped).length > 0) {
            const searchId = Date.now();
            const newJournalEntries = [];
            for (const [m, arr] of Object.entries(grouped)) {
                const h = document.createElement('div'); h.className = 'mgr'; h.textContent = `–ú–µ–Ω–µ–¥–∂–µ—Ä ${m}:`; out.appendChild(h);
                const ol = document.createElement('ol');
                arr.forEach(v => {
                    const li = document.createElement('li'); li.textContent = v; ol.appendChild(li);
                    newJournalEntries.push({ id: Date.now() + Math.random(), user: currentUser, manager: m, employee: v, date: now, shift: '1-–°–º–µ–Ω–∞', searchId: searchId });
                });
                out.appendChild(ol);
            }
            const todayDate = new Date().toLocaleDateString('ru-RU');
            const todaySearches = new Set(journal.filter(e => e.date.startsWith(todayDate)).map(e => e.searchId)).size;
            const shift = todaySearches === 0 ? '1-–°–º–µ–Ω–∞' : todaySearches === 1 ? '2-–°–º–µ–Ω–∞' : '–û—Ç–∫—Ä—ã—Ç–∞—è —Å–º–µ–Ω–∞';
            newJournalEntries.forEach(e => e.shift = shift);
            await addToJournal(newJournalEntries);
            copyWrap.style.display = 'block';

            const foundLines = Object.values(grouped).flat().map(line => transliterate(line));
            let updatedTrainingList = [...trainingList];
            let removedCount = 0;
            updatedTrainingList = updatedTrainingList.filter(fio => {
                const preparedFio = transliterate(fio);
                for (const line of foundLines) {
                    if (similarity(line, preparedFio) > 0.65) {
                        removedCount++;
                        return false;
                    }
                }
                return true;
            });
            if (removedCount > 0) {
                 await saveTrainingList(updatedTrainingList);
                 showToast(`–û—Ç–º–µ—á–µ–Ω–æ –≤ —Å–ø–∏—Å–∫–µ –Ω–∞ —Ç—Ä–µ–Ω–∏–Ω–≥: ${removedCount} —á–µ–ª.`);
            }

        } else if(guests.length === 0) {
             empty.textContent = '–°–æ–≤–ø–∞–¥–µ–Ω–∏–π –Ω–µ—Ç';
        }
        
        lastExport = grouped;
        ta.value = "";
    }
    
    function doImportFromExcel(file){
        const r = new FileReader();
        r.onload = e => {
            try {
                const data = new Uint8Array(e.target.result);
                const wb = XLSX.read(data, {type:'array'});
                const ws = wb.Sheets[wb.SheetNames[0]];
                const rows = XLSX.utils.sheet_to_json(ws, {header:1, raw:false});
                
                const newDB = {};
                if (rows.length < 1) { showToast("–§–∞–π–ª Excel –ø—É—Å—Ç.", true); return; }
                const firstRowCell = String(rows[0][0] || '').toLowerCase();
                const startingRow = (firstRowCell.includes('–º–µ–Ω–µ–¥–∂–µ—Ä') || firstRowCell.includes('manager')) ? 1 : 0;
                for (let i = startingRow; i < rows.length; i++) {
                    const row = rows[i];
                    const manager = String(row[0] || '').trim();
                    const codesString = String(row[1] || '').trim();
                    if (!manager || !codesString) continue;
                    const codesArray = codesString.split(',').map(code => code.trim()).filter(Boolean);
                    if (codesArray.length > 0) newDB[manager] = codesArray;
                }
                if (Object.keys(newDB).length === 0) { showToast("–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ —Ñ–∞–π–ª–µ.", true); return; }
                showConfirm(`–ù–∞–π–¥–µ–Ω–æ ${Object.keys(newDB).length} –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤. –û–±–Ω–æ–≤–∏—Ç—å –æ–±—â—É—é –±–∞–∑—É?`, () => saveDB(newDB));
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞ Excel:", error);
                showToast("–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞ Excel.", true);
            }
        };
        r.readAsArrayBuffer(file);
    }
    
    async function addToJournal(newEntries){
        journal.push(...newEntries);
        await saveJournal(currentUser, journal);
    }
    
    function renderJournal(journalData) {
        const body = document.getElementById("journalBody");
        body.innerHTML = "";
        if (journalData.length === 0) {
            body.innerHTML = "<p class='muted' style='text-align:center;'>–ó–∞–ø–∏—Å–µ–π –≤ –∂—É—Ä–Ω–∞–ª–µ –Ω–µ—Ç</p>";
            return;
        }
        journalData.sort((a,b) => new Date(b.id) - new Date(a.id));
        const groupedByDate = {};
        journalData.forEach(entry => {
            const dateKey = entry.date.split(',')[0]; 
            if (!groupedByDate[dateKey]) groupedByDate[dateKey] = [];
            groupedByDate[dateKey].push(entry);
        });
        const sortedDates = Object.keys(groupedByDate).sort((a, b) => {
             const dateA = a.split('.').reverse().join('-');
             const dateB = b.split('.').reverse().join('-');
             return new Date(dateB) - new Date(dateA);
        });
        sortedDates.forEach((date) => {
            const entriesForDate = groupedByDate[date];
            const details = document.createElement("details");
            details.className = "date-group";
            details.open = true;
            const summary = document.createElement("summary");
            summary.textContent = date;
            details.appendChild(summary);
            const contentDiv = document.createElement("div");
            contentDiv.className = "date-content";
            const table = document.createElement("table");
            table.className = "journal-table";
            table.innerHTML = `<thead><tr><th>–ö—Ç–æ –∏—Å–∫–∞–ª</th><th>–°–º–µ–Ω–∞</th><th>–ú–µ–Ω–µ–¥–∂–µ—Ä</th><th>–°–æ—Ç—Ä—É–¥–Ω–∏–∫ / –ú–∞–≥–∞–∑–∏–Ω</th><th>–í—Ä–µ–º—è</th></tr></thead>`;
            const tbody = document.createElement("tbody");
            entriesForDate.forEach(entry => {
                const tr = document.createElement("tr");
                const time = entry.date.split(',')[1] || '';
                const shiftSelect = `<select data-entry-id="${entry.id}" onchange="handleShiftChange(event)">
                        <option value="1-–°–º–µ–Ω–∞" ${entry.shift === '1-–°–º–µ–Ω–∞' ? 'selected' : ''}>1-–°–º–µ–Ω–∞</option>
                        <option value="2-–°–º–µ–Ω–∞" ${entry.shift === '2-–°–º–µ–Ω–∞' ? 'selected' : ''}>2-–°–º–µ–Ω–∞</option>
                        <option value="–û—Ç–∫—Ä—ã—Ç–∞—è —Å–º–µ–Ω–∞" ${entry.shift === '–û—Ç–∫—Ä—ã—Ç–∞—è —Å–º–µ–Ω–∞' ? 'selected' : ''}>–û—Ç–∫—Ä—ã—Ç–∞—è</option>
                    </select>`;
                tr.innerHTML = `<td>${entry.user}</td><td>${shiftSelect}</td><td>${entry.manager}</td><td>${entry.employee}</td><td>${time}</td>`;
                tbody.appendChild(tr);
            });
            table.appendChild(tbody);
            contentDiv.appendChild(table);
            details.appendChild(contentDiv);
            body.appendChild(details);
        });
    }

    function renderTrainingList() {
        const container = document.getElementById('trainingListContainer');
        const statusEl = document.getElementById('trainingStatus');
        container.innerHTML = '';
        if (trainingList.length === 0) {
            statusEl.textContent = '–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç. –í—Å–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã! üéâ';
            return;
        }
        statusEl.textContent = `–û—Å—Ç–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å: ${trainingList.length} –∏–∑ ${initialTrainingListSize}`;
        trainingList.forEach(item => {
            const li = document.createElement('li');
            li.textContent = item;
            container.appendChild(li);
        });
    }

    function renderGuestList() {
        const container = document.getElementById('guestListContainer');
        container.innerHTML = "";
        if (guestList.length === 0) {
            container.innerHTML = "<p class='muted' style='text-align:center;'>–ñ—É—Ä–Ω–∞–ª –≥–æ—Å—Ç–µ–π –ø—É—Å—Ç</p>";
            return;
        }
        const sortedGuests = [...guestList].sort((a,b) => new Date(b.id) - new Date(a.id));
        const table = document.createElement("table");
        table.className = "journal-table";
        table.innerHTML = `<thead><tr><th>–ó–∞–ø–∏—Å—å</th><th>–ö—Ç–æ –¥–æ–±–∞–≤–∏–ª</th><th>–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è</th></tr></thead>`;
        const tbody = document.createElement("tbody");
        sortedGuests.forEach(guest => {
            const tr = document.createElement("tr");
            tr.innerHTML = `<td>${guest.text}</td><td>${guest.user}</td><td>${guest.date}</td>`;
            tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        container.appendChild(table);
    }

    async function handleShiftChange(event) {
        const entryId = parseFloat(event.target.dataset.entryId);
        const newShift = event.target.value;
        const userOfEntry = displayedJournal.find(e => e.id === entryId)?.user;
        if (!userOfEntry) return;
        const userJournal = await loadJournal(userOfEntry);
        const entryToUpdate = userJournal.find(e => e.id === entryId);
        if (entryToUpdate) {
            entryToUpdate.shift = newShift;
            await saveJournal(userOfEntry, userJournal);
            const displayedEntry = displayedJournal.find(e => e.id === entryId);
            if(displayedEntry) displayedEntry.shift = newShift;
        }
    }

    function exportSearch(){
        if(Object.keys(lastExport).length===0){ showToast("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞", true); return; }
        const ws_data=[];
        for(const [m,arr] of Object.entries(lastExport)){
            ws_data.push([`–ú–µ–Ω–µ–¥–∂–µ—Ä ${m}:`]);
            arr.forEach((v,i)=>ws_data.push([`${i+1}. ${v}`]));
            ws_data.push([]);
        }
        const ws=XLSX.utils.aoa_to_sheet(ws_data);
        const wb=XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb,ws,"–†–µ–∑—É–ª—å—Ç–∞—Ç—ã");
        XLSX.writeFile(wb,"olma-search.xlsx");
    }

    function exportJournal(){
        if(displayedJournal.length === 0){ showToast("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞.", true); return; }
        const ws_data=[["–ö—Ç–æ –∏—Å–∫–∞–ª","–°–º–µ–Ω–∞","–ú–µ–Ω–µ–¥–∂–µ—Ä","–°–æ—Ç—Ä—É–¥–Ω–∏–∫ / –ú–∞–≥–∞–∑–∏–Ω", "–î–∞—Ç–∞", "–í—Ä–µ–º—è"]];
        displayedJournal.forEach(entry => {
            const [date, time] = entry.date.split(',');
            ws_data.push([entry.user, entry.shift, entry.manager, entry.employee, date, time]);
        });
        const ws=XLSX.utils.aoa_to_sheet(ws_data);
        const wb=XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb,ws,"–ñ—É—Ä–Ω–∞–ª");
        XLSX.writeFile(wb,`olma-journal-export.xlsx`);
    }

    function exportGuests() {
        if (guestList.length === 0) { showToast("–ñ—É—Ä–Ω–∞–ª –≥–æ—Å—Ç–µ–π –ø—É—Å—Ç.", true); return; }
        const ws_data = [["–ó–∞–ø–∏—Å—å", "–ö—Ç–æ –¥–æ–±–∞–≤–∏–ª", "–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è"]];
        guestList.forEach(g => ws_data.push([g.text, g.user, g.date]));
        const ws = XLSX.utils.aoa_to_sheet(ws_data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "–ì–æ—Å—Ç–∏");
        XLSX.writeFile(wb, `olma-guests.xlsx`);
    }

    function doCopyResults(){
        const out=document.getElementById('results');
        if(!out.textContent.trim()){ showToast("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è", true); return; }
        const text=Array.from(out.children).map(n=>n.textContent).join("\n");
        navigator.clipboard?.writeText(text).then(()=>toastCopied()).catch(()=>legacyCopy(text));
    }
    function legacyCopy(t){
        const ta=document.createElement("textarea"); ta.value=t; document.body.appendChild(ta); ta.select();
        try{ document.execCommand("copy"); }catch{} document.body.removeChild(ta); toastCopied();
    }
    function toastCopied(){ const msg=document.getElementById("emptyMsg"); const p=msg.textContent; msg.textContent="‚úî –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ"; setTimeout(()=>msg.textContent=p,1200); }

    function populateUserFilter() {
        const userSelect = document.getElementById("userSelect");
        const filterUserSelect = document.getElementById("filterUser");
        filterUserSelect.innerHTML = '<option value="all">–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</option>';
        for (let i = 1; i < userSelect.options.length; i++) {
            const option = userSelect.options[i];
            filterUserSelect.add(new Option(option.text, option.value));
        }
    }

    function checkTrainingReminder() {
        if (sessionStorage.getItem('trainingReminderShown')) return;
        const now = new Date();
        const isFriday = now.getDay() === 5;
        const isAfter5PM = now.getHours() >= 17;
        if (isFriday && isAfter5PM && trainingList.length > 0) {
            const remaining = trainingList.slice(0, 5).join('\n');
            const message = `–í–ù–ò–ú–ê–ù–ò–ï!\n\n–í —Å–ø–∏—Å–∫–µ –Ω–∞ —Ç—Ä–µ–Ω–∏–Ω–≥ –æ—Å—Ç–∞–ª–∏—Å—å –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏:\n\n${remaining}\n\n${trainingList.length > 5 ? `...–∏ –µ—â–µ ${trainingList.length - 5}.` : ''}`;
            alert(message);
            sessionStorage.setItem('trainingReminderShown', 'true');
        }
    }
    
    document.addEventListener("DOMContentLoaded", populateUserFilter);

    document.getElementById("btnStart").addEventListener("click", async () => {
        const userSelect = document.getElementById("userSelect");
        if (userSelect.value) {
            currentUser = userSelect.value;
            await loadDB(); 
            journal = await loadJournal(currentUser); 
            await loadTrainingList();
            await loadGuestList();
            checkTrainingReminder();
            document.getElementById("welcomeOverlay").style.display = "none";
            document.getElementById("mainApp").style.display = "flex";
            document.getElementById("topNav").style.display = "flex";
        } else {
            showToast("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à–µ –§–ò–û", true);
        }
    });

    document.getElementById("btnCopy").addEventListener("click", doCopyResults);
    document.getElementById("btnSearch").addEventListener("click", doSearch);
    document.getElementById("btnExport").addEventListener("click", exportSearch);
    document.getElementById("btnImport").addEventListener("click", ()=>document.getElementById("fileInput").click());
    document.getElementById("fileInput").addEventListener("change", e => { const f=e.target.files[0]; if(f) doImportFromExcel(f); e.target.value=""; });
    document.getElementById("btnJournal").addEventListener("click", () => document.getElementById("filterOverlay").style.display = "flex");
    document.getElementById("btnCancelFilter").addEventListener("click", () => document.getElementById("filterOverlay").style.display = "none");
    document.getElementById("btnApplyFilter").addEventListener("click", async () => {
        const selectedUser = document.getElementById('filterUser').value;
        let journalData = [];
        if (selectedUser === 'all') {
            const journalsRef = firestore.collection("journals");
            const snapshot = await journalsRef.get();
            snapshot.forEach(doc => { journalData = journalData.concat(doc.data().entries || []); });
        } else {
            journalData = await loadJournal(selectedUser);
        }
        displayedJournal = journalData;
        renderJournal(journalData);
        document.getElementById("filterOverlay").style.display = "none";
        document.getElementById("journalOverlay").style.display = "flex";
    });
    document.getElementById("closeJournal").addEventListener("click", ()=>document.getElementById("journalOverlay").style.display="none");
    document.getElementById("btnExportJournal").addEventListener("click", exportJournal);
    document.getElementById('input').addEventListener('keydown', function(event) { if (event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); document.getElementById('btnSearch').click(); }});
    document.getElementById('passwordInput').addEventListener('keydown', function(event) { if (event.key === 'Enter') { document.getElementById('btnConfirmClear').click(); }});
    
    document.getElementById("btnClearJournal").addEventListener("click", () => {
        requestPassword(() => {
            const userToClear = displayedJournal.length > 0 ? displayedJournal[0].user : currentUser;
            showConfirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –í–ï–°–¨ –∂—É—Ä–Ω–∞–ª –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${userToClear}?`, async () => {
                await saveJournal(userToClear, []);
                if(userToClear === currentUser) journal = [];
                displayedJournal = [];
                renderJournal([]);
                showToast("–ñ—É—Ä–Ω–∞–ª –¥–ª—è " + userToClear + " –æ—á–∏—â–µ–Ω.");
            });
        });
    });

    document.getElementById('btnClearGuests').addEventListener('click', () => {
        requestPassword(() => {
            showConfirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—Å—Ç–∏—Ç—å –∂—É—Ä–Ω–∞–ª –≥–æ—Å—Ç–µ–π?', async () => {
                await saveGuestList([]);
                await loadGuestList();
                renderGuestList();
                showToast("–ñ—É—Ä–Ω–∞–ª –≥–æ—Å—Ç–µ–π –æ—á–∏—â–µ–Ω.");
            });
        });
    });
    
    document.getElementById('btnTraining').addEventListener('click', () => {
        renderTrainingList();
        document.getElementById('trainingOverlay').style.display = 'flex';
    });
    document.getElementById('closeTraining').addEventListener('click', () => document.getElementById('trainingOverlay').style.display = 'none');
    
    document.getElementById('btnEditTrainingList').addEventListener('click', () => {
        document.getElementById('trainingListInput').value = trainingList.join('\n');
        document.getElementById('uploadTrainingOverlay').style.display = 'flex';
    });
    document.getElementById('btnCancelUpload').addEventListener('click', () => {
        document.getElementById('uploadTrainingOverlay').style.display = 'none';
    });
    document.getElementById('btnSaveTrainingList').addEventListener('click', async () => {
        const text = document.getElementById('trainingListInput').value;
        const newList = text.split('\n').map(line => line.trim()).filter(Boolean);
        await saveTrainingList(newList, true);
        renderTrainingList();
        document.getElementById('uploadTrainingOverlay').style.display = 'none';
    });
    
    document.getElementById('btnGuests').addEventListener('click', () => {
        renderGuestList();
        document.getElementById('guestOverlay').style.display = 'flex';
    });
    document.getElementById('closeGuests').addEventListener('click', () => document.getElementById('guestOverlay').style.display = 'none');
    document.getElementById('btnExportGuests').addEventListener('click', exportGuests);
</script>
</body>
</html>