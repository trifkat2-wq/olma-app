<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <title>Olma Market — Поиск менеджера</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <style>
        :root{
            --olma-red: rgb(239,62,45);
            --olma-green: rgb(77,185,109);
            --olma-yellow: rgb(255,198,62);
            --olma-black: #202020;
            --card-w: 520px;
        }
        *{box-sizing:border-box}
        body{
            margin:0;
            font-family: Arial, Helvetica, sans-serif;
            background:#f3f4f6;
            display:flex;
            flex-direction: column; /* ИЗМЕНЕНИЕ 5: Для вертикального расположения */
            align-items:center;
            justify-content:center;
            min-height:100vh;
            padding: 16px 0;
        }

        /* ИЗМЕНЕНИЕ 5: Стили для новой верхней панели */
        .top-nav {
            width: 100%;
            background-color: #ffffff;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            padding: 12px 16px;
            margin-bottom: 24px;
            display: flex;
            justify-content: center;
            gap: 12px;
            order: -1; /* Чтобы панель была всегда вверху */
        }
        .top-nav .btn-journal {
             box-shadow: none;
             border: 1.5px solid #e5e7eb;
        }
        .top-nav .btn-journal:hover {
            background-color: #f9fafb;
            border-color: #d1d5db;
        }
        #mainApp {
            width: 100%;
            display: flex;
            justify-content: center;
        }
        /* Конец изменений 5 */

        .card{
            width: min(var(--card-w), 96vw);
            background:#fff;
            border-radius:16px;
            box-shadow:0 8px 24px rgba(0,0,0,.12);
            padding:22px 24px 18px;
            text-align:center;
        }
        .logo{ width:180px; margin:2px auto 10px; display:block; object-fit:contain; }
        h1, h2{ margin:4px 0 14px; color:var(--olma-black); }
        h1 { font-size:28px; }
        h2 { font-size:22px; }
        textarea, select, input[type="password"] {
            display:block; width:100%;
            padding:10px 12px; border:1.5px solid #d1d5db; border-radius:10px;
            font-family: ui-monospace, monospace; font-size:14px; line-height:1.4;
            resize:vertical; margin:0 auto 14px;
        }
        textarea{ height:120px; }
        .btn{
            display:block; width:100%; border:none; border-radius:12px;
            padding:12px 16px; font-size:16px; font-weight:700;
            cursor:pointer; transition:transform .02s ease, opacity .2s ease;
            color:#fff; margin:10px auto 0;
        }
        .btn:active{ transform:scale(.995); }
        .btn[disabled] { background-color: #9ca3af; cursor: not-allowed; }
        .btn-red{ background:var(--olma-red); }
        .btn-green{ background:var(--olma-green); }
        .btn-yellow{ background:var(--olma-yellow); color:#212121; }
        .results{ text-align:left; margin-top:14px; }
        .mgr{ font-weight:700; color:var(--olma-black); margin:14px 0 6px }
        ol{ margin:6px 0 0 18px; padding-left: 18px; }
        .muted{ color:#6b7280; font-style:italic; margin-top:8px }
        .copy-wrap{ display:none; margin-top:12px; text-align:center; }
        .copy-btn{ width:28px; height:28px; border:none; background:transparent; cursor:pointer; opacity:.75; padding:0; margin:0 auto; }
        .copy-btn:hover{ opacity:1 } .copy-btn:active{ transform:scale(.98) }
        .copy-btn svg{ width:100%; height:100%; display:block; }
        
        .btn-journal{
            background:#fff; border:none; border-radius:8px; padding:6px 12px;
            font-weight:600; font-size:14px; cursor:pointer;
            box-shadow:0 2px 6px rgba(0,0,0,.15);
            line-height: 1.2;
        }
        .btn-journal:hover{ background:#f9f9f9; }
        
        .overlay{
            position:fixed; top:0; left:0; right:0; bottom:0;
            background:rgba(0,0,0,0.4);
            display:flex; align-items:center; justify-content:center;
            z-index:1000;
        }
        .password-overlay, .confirm-overlay { z-index: 1100; }
        
        .journal-window{
            width:90vw; height:80vh;
            background:#fff; border-radius:14px;
            box-shadow:0 8px 24px rgba(0,0,0,.25);
            display:flex; flex-direction:column; overflow:hidden;
        }
        .journal-header{
            flex:0 0 auto; padding:12px 16px; background:#f3f4f6;
            border-bottom:1px solid #ddd; display:flex; justify-content:space-between; align-items:center;
        }
        .journal-header h2{ margin:0; font-size:18px; font-weight:700; }
        .journal-close{ border:none; background:transparent; font-size:20px; cursor:pointer; }
        .journal-body{ flex:1 1 auto; overflow:auto; padding:12px; text-align:left; }
        table.journal-table{ border-collapse:collapse; width:100%; font-size:14px; }
        .journal-table th,.journal-table td{ border:1px solid #ddd; padding:6px 8px; text-align:left; vertical-align: top; }
        .journal-table th{ background:#f9fafb; }
        .journal-table select { border: 1px solid #ddd; border-radius: 4px; padding: 2px; }
        .journal-footer{ padding:10px; border-top:1px solid #ddd; text-align:right; display:flex; justify-content:space-between; }
        .btn-export-journal, .btn-clear-journal{
            background:var(--olma-green); color:#fff; border:none;
            padding:8px 14px; border-radius:8px; font-weight:600; cursor:pointer;
        }
        .btn-clear-journal{ background:var(--olma-red); }
        
        details.date-group { border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 12px; }
        details.date-group summary {
            font-weight: 700; font-size: 16px; padding: 10px 14px; cursor: pointer;
            background-color: #f9fafb;
        }
        details[open].date-group summary { border-bottom: 1px solid #e5e7eb; }
        .date-content { padding: 8px; }

        .modal-window .form-group{ text-align: left; margin-bottom: 12px; }
        .modal-window .form-group label{ font-weight: 600; font-size: 14px; margin-bottom: 4px; display: block; }
        .modal-window p { margin: 10px 0 20px; }
        .modal-buttons { display: flex; gap: 10px; justify-content: flex-end; }

        .toast {
            position: fixed; top: 20px; left: 50%;
            transform: translateX(-50%);
            background-color: var(--olma-green); color: white;
            padding: 12px 20px; border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 2000; opacity: 0; visibility: hidden;
            transition: opacity 0.3s ease, top 0.3s ease, visibility 0.3s ease;
        }
        .toast.show { opacity: 1; visibility: visible; top: 40px; }
        .toast.error { background-color: var(--olma-red); }

        @media (max-width: 520px) {
            .card { padding: 20px 16px 16px; }
            h1 { font-size: 24px; margin-bottom: 12px; }
            .btn { padding: 11px 14px; font-size: 15px; margin-top: 8px; }
            textarea { height: 100px; font-size: 13px; }
            .logo { width: 150px; }
            .journal-window { width: 95vw; height: 85vh; }
        }
    </style>
</head>
<body>
    <div id="welcomeOverlay" class="overlay">
        <div class="card welcome-card">
            </div>
    </div>

    <div class="top-nav" id="topNav" style="display: none;">
        <button class="btn-journal" id="btnGuests">Гости</button>
        <button class="btn-journal" id="btnTraining">Тренинг</button>
        <button class="btn-journal" id="btnJournal">Журнал</button>
    </div>

    <div id="mainApp" style="display: none;">
        <div class="card">
            <img class="logo" src="logo_olma_hd_transparent.png" alt="Olma Market" onerror="this.style.display='none'">
            <h1>Поиск менеджера</h1>
            </div>
    </div>
    
    <div id="uploadTrainingOverlay" class="overlay" style="display: none;">
        <div class="card modal-window" style="width: min(500px, 90vw);">
            <h2>Редактирование списка</h2>
            <p>Добавьте, удалите или исправьте ФИО. Каждый сотрудник с новой строки.</p>
            <textarea id="trainingListInput" style="height: 200px; font-size: 13px;"></textarea>
            <div class="modal-buttons">
                <button class="btn" id="btnCancelUpload" style="background-color: #6b7280;">Отмена</button>
                <button class="btn btn-green" id="btnSaveTrainingList">Сохранить изменения</button>
            </div>
        </div>
    </div>
    
<script>
    // ... Firebase Config ...

    // ... Глобальные переменные ...

    // ... Функции showToast, showConfirm, requestPassword ...

    // ... Функции для работы с Firebase (loadDB, saveDB, и т.д.) ...

    // ИЗМЕНЕНИЯ 3 и 4: Новые функции для "умного" сравнения
    function transliterate(text) {
        text = text.toLowerCase();
        const a = {"Ё":"YO","Й":"I","Ц":"TS","У":"U","К":"K","Е":"E","Н":"N","Г":"G","Ш":"SH","Щ":"SCH","З":"Z","Х":"H","Ъ":"'","ё":"yo","й":"i","ц":"ts","у":"u","к":"k","е":"e","н":"n","г":"g","ш":"sh","щ":"sch","з":"z","х":"h","ъ":"'","Ф":"F","Ы":"I","В":"V","А":"a","П":"P","Р":"R","О":"O","Л":"L","Д":"D","Ж":"ZH","Э":"E","ф":"f","ы":"i","в":"v","а":"a","п":"p","р":"r","о":"o","л":"l","д":"d","ж":"zh","э":"e","Я":"Ya","Ч":"CH","С":"S","М":"M","И":"I","Т":"T","Ь":"'","Б":"B","Ю":"YU","я":"ya","ч":"ch","с":"s","м":"m","и":"i","т":"t","ь":"'","б":"b","ю":"yu"};
        return text.split('').map(char => a[char] || char).join("");
    }

    function similarity(s1, s2) {
        let longer = s1;
        let shorter = s2;
        if (s1.length < s2.length) {
            longer = s2;
            shorter = s1;
        }
        const longerLength = longer.length;
        if (longerLength === 0) {
            return 1.0;
        }
        return (longerLength - editDistance(longer, shorter)) / parseFloat(longerLength);
    }

    function editDistance(s1, s2) {
        s1 = s1.toLowerCase();
        s2 = s2.toLowerCase();
        const costs = [];
        for (let i = 0; i <= s1.length; i++) {
            let lastValue = i;
            for (let j = 0; j <= s2.length; j++) {
                if (i === 0) {
                    costs[j] = j;
                } else {
                    if (j > 0) {
                        let newValue = costs[j - 1];
                        if (s1.charAt(i - 1) !== s2.charAt(j - 1)) {
                            newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
                        }
                        costs[j - 1] = lastValue;
                        lastValue = newValue;
                    }
                }
            }
            if (i > 0) costs[s2.length] = lastValue;
        }
        return costs[s2.length];
    }
    // Конец изменений 3 и 4

    // ... Остальные функции (doImportFromExcel, render..., и т.д.) ...
    
    // ИЗМЕНЕНИЕ 1: Полностью переработанная логика doSearch
    async function doSearch() {
        const ta = document.getElementById('input');
        const raw = ta.value.trim();
        const out = document.getElementById('results');
        const empty = document.getElementById('emptyMsg');
        const copyWrap = document.getElementById('copyWrap');
        out.innerHTML = ''; empty.textContent = ''; copyWrap.style.display = 'none';

        if (!raw) { empty.textContent = 'Введите данные'; return; }
        if (Object.keys(DB).length === 0) { empty.textContent = 'База пуста.'; return; }

        const lines = raw.split(/\n/).map(s => s.trim()).filter(Boolean);
        const codeMap = buildCodeMap(DB);
        const grouped = {};
        const guests = [];
        const guestRegex = /\b(ТМ|АМ|ЗМ|РМ)\b/i;
        
        // Создаем подготовленный для поиска список тренинга
        const trainingSet = trainingList.map(fio => transliterate(fio));

        for (const line of lines) {
            let hasManager = false;
            let isGuestByCode = guestRegex.test(line);
            
            CODE_RE.lastIndex = 0;
            let match;
            while ((match = CODE_RE.exec(line)) !== null) {
                const normalizedCode = normalizeCode(match[1], match[2]);
                const manager = codeMap[normalizedCode];
                if (manager) {
                    if (!grouped[manager]) grouped[manager] = [];
                    if (!grouped[manager].includes(line)) grouped[manager].push(line);
                    hasManager = true;
                }
            }

            let isInTraining = false;
            if (hasManager) {
                const preparedLine = transliterate(line);
                for (const trainingFio of trainingSet) {
                    if (similarity(preparedLine, trainingFio) > 0.6) {
                        isInTraining = true;
                        break;
                    }
                }
            }
            
            // Определяем, кто является гостем по новым правилам
            if (isGuestByCode || !hasManager || (hasManager && !isInTraining)) {
                guests.push(line);
                // Если сотрудник был найден, но попал в гости (т.к. не в списке тренинга),
                // его нужно убрать из основного списка `grouped`
                if (hasManager) {
                    for (const manager in grouped) {
                        grouped[manager] = grouped[manager].filter(item => item !== line);
                        if (grouped[manager].length === 0) delete grouped[manager];
                    }
                }
            }
        }
        
        const now = new Date().toLocaleString('ru-RU', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });

        if (guests.length > 0) {
            // ... логика сохранения гостей
        }

        if (Object.keys(grouped).length > 0) {
            // ... логика отображения найденных
            // ... логика записи в журнал
            
            // Обновленная логика "минусования" из тренинга
            const foundEmployeesLines = Object.values(grouped).flat();
            let updatedTrainingList = [...trainingList];
            let removedCount = 0;

            updatedTrainingList = updatedTrainingList.filter(fio => {
                const preparedFio = transliterate(fio);
                for (const line of foundEmployeesLines) {
                    if (similarity(transliterate(line), preparedFio) > 0.6) {
                        removedCount++;
                        return false; // Нашли совпадение, удаляем из списка
                    }
                }
                return true; // Совпадений не найдено, оставляем
            });

            if (removedCount > 0) {
                await saveTrainingList(updatedTrainingList);
                showToast(`Отмечено в списке на тренинг: ${removedCount} чел.`);
            }

        } else if(guests.length === 0) {
             empty.textContent = 'Совпадений нет';
        }
        
        lastExport = grouped;
        ta.value = "";
    }


    document.getElementById("btnStart").addEventListener("click", async () => {
        // ...
        document.getElementById("mainApp").style.display = "flex"; // ИЗМЕНЕНИЕ 5
        document.getElementById("topNav").style.display = "flex"; // ИЗМЕНЕНИЕ 5
        // ...
    });
    
    // ИЗМЕНЕНИЕ 2: Обработчик кнопки редактирования списка тренинга
    document.getElementById('btnTraining').addEventListener('click', () => {
        document.getElementById('trainingListInput').value = trainingList.join('\n');
        renderTrainingList(); // Сначала рендерим, чтобы видеть статус
        document.getElementById('trainingOverlay').style.display = 'flex';
    });

    document.getElementById('btnUploadTrainingList').addEventListener('click', () => {
        document.getElementById('trainingListInput').value = trainingList.join('\n');
        document.getElementById('uploadTrainingOverlay').style.display = 'flex';
    });

</script>
</body>
</html>